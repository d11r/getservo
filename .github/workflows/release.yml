name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build macOS binaries
        run: |
          cd packages/mcp-server/native/macos
          # Build for arm64
          swiftc -O -o servo-helper-darwin-arm64 Sources/main.swift -framework Cocoa -framework CoreGraphics -framework ApplicationServices -target arm64-apple-macos12
          # Build for x64
          swiftc -O -o servo-helper-darwin-x64 Sources/main.swift -framework Cocoa -framework CoreGraphics -framework ApplicationServices -target x86_64-apple-macos12

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            packages/mcp-server/native/macos/servo-helper-darwin-arm64
            packages/mcp-server/native/macos/servo-helper-darwin-x64

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build Windows binary
        run: |
          cd packages/mcp-server/native/windows
          dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o output

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: packages/mcp-server/native/windows/output/servo-helper.exe

  publish:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Create bin directory
        run: mkdir -p packages/mcp-server/bin

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries
          path: packages/mcp-server/bin

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: packages/mcp-server/bin

      - name: Rename Windows binary
        run: mv packages/mcp-server/bin/servo-helper.exe packages/mcp-server/bin/servo-helper-win32-x64.exe

      - name: Make binaries executable
        run: chmod +x packages/mcp-server/bin/*

      - name: List binaries
        run: ls -la packages/mcp-server/bin/

      - name: Build JS bundle
        run: |
          cd packages/mcp-server
          pnpm build:js

      - name: Publish to npm
        run: |
          cd packages/mcp-server
          npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true
          files: |
            packages/mcp-server/bin/servo-helper-darwin-arm64
            packages/mcp-server/bin/servo-helper-darwin-x64
            packages/mcp-server/bin/servo-helper-win32-x64.exe
